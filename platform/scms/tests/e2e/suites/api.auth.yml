# Tests for all API routes as an authenticated user
# This file tests how routes behave for logged-in users
title: API Routes (Authenticated User)
system_role: USER
headers:
  Authorization: Bearer ${TOKEN}
cases:
  # Base API Routes Group
  - title: Base API Routes
    cases:
      - title: API root endpoint returns version info
        url: /v1
        status: 200
        response:
          version: string
          message: string

      - title: API root endpoint with trailing slash returns version info
        url: /v1/
        status: 200
        response:
          version: string
          message: string

      - title: Config endpoint returns user configuration
        url: /v1/config
        status: 200
        response:
          apiUrl: string

      - title: Login endpoint rejects invalid token type
        url: /v1/login
        method: POST
        status: 401
        response:
          status: string
          message: string
          exact:
            message: Invalid token type

      - title: Unknown API route returns 404 error
        url: /v1/not/a/real/route
        status: 404
        response:
          error: string

  # Token Routes Group
  - title: Token Routes
    cases:
      - title: Session token endpoint validates token
        url: /v1/tokens/session
        status: 200
        response:
          valid: boolean
          exact:
            valid: true

      - title: User token endpoint rejects invalid token type
        url: /v1/tokens/user
        status: 401
        response:
          status: string
          message: string
          exact:
            message: Invalid token type

  # My Routes Group
  - title: My Routes
    cases:
      - title: My user endpoint returns authenticated user profile
        url: /v1/my/user
        status: 200
        response:
          id: string
          email: string
          display_name: string

      - title: My sites endpoint returns user's sites
        url: /v1/my/sites
        status: 200
        response:
          items: array
          links: object

      - title: My works endpoint returns user's works
        url: /v1/my/works
        status: 200
        response:
          items: array
          links: object

      - title: My work by ID returns 404 for non-existent work
        url: /v1/my/works/does-not-exist
        status: 404

      - title: My submissions endpoint returns user's submissions
        url: /v1/my/submissions
        status: 200
        response:
          items: array
          links: object

      - title: My submission by ID returns 404 for non-existent submission
        url: /v1/my/submissions/does-not-exist
        status: 404
        response:
          error: string

  # Sites Routes Group
  - title: Sites Routes
    cases:
      - title: Sites list endpoint returns all sites
        url: /v1/sites
        status: 200
        response:
          items: array
          links: object

      - title: Site by name endpoint returns site details
        url: /v1/sites/science
        status: 200
        response:
          id: string
          name: string
          url: string
          private: boolean
          collections: array
          links: object

      - title: Site access endpoint returns user permissions
        url: /v1/sites/science/access
        status: 200
        response:
          read: boolean
          submit: boolean

      - title: Site sign endpoint requires site role
        url: /v1/sites/science/sign
        method: POST
        status: 401

      - title: Site collections endpoint returns site collections
        url: /v1/sites/science/collections
        status: 200
        response:
          items: array
          links: object

      - title: Site collection by ID returns collection details
        url: /v1/sites/science/collections/018b9034-d660-7a20-9135-5794c1eb0bfd
        status: 200
        response:
          id: string
          name: string
          links: object

      - title: Site kinds endpoint returns site kinds
        url: /v1/sites/science/kinds
        status: 200
        response:
          items: array
          links: object

      - title: Site kind by ID returns kind details
        url: /v1/sites/science/kinds/018b9034-d660-7a20-9135-5794c1eb0bf0
        status: 200
        response:
          id: string
          name: string
          links: object

      - title: Site DOI endpoint returns 404 for non-existent DOI
        url: /v1/sites/science/doi/10.1234/5678
        status: 404
        response:
          status: string
          message: string

  # Site Works Routes Group
  - title: Site Works Routes
    cases:
      - title: Site works endpoint returns site works
        url: /v1/sites/science/works
        status: 200
        response:
          items: array
          links: object

      - title: Site work by ID returns 404 for non-existent work
        url: /v1/sites/science/works/does-not-exist
        status: 404
        response:
          error: string

      - title: Site work thumbnail returns 404 for non-existent work
        url: /v1/sites/science/works/does-not-exist/thumbnail
        status: 404
        response:
          error: string

      - title: Site work social returns 404 for non-existent work
        url: /v1/sites/science/works/does-not-exist/social
        status: 404
        response:
          error: string

      - title: Site work published returns 404 for non-existent work
        url: /v1/sites/science/works/does-not-exist/published
        status: 404
        response:
          error: string

      - title: Site work versions returns 404 for non-existent work
        url: /v1/sites/science/works/does-not-exist/versions
        status: 404
        response:
          error: string

      - title: Site work version by ID returns 404 for non-existent version
        url: /v1/sites/science/works/does-not-exist/versions/does-not-exist
        status: 404
        response:
          error: string

      - title: Site work version thumbnail returns 404 for non-existent version
        url: /v1/sites/science/works/does-not-exist/versions/does-not-exist/thumbnail
        status: 404
        response:
          error: string

      - title: Site work version social returns 404 for non-existent version
        url: /v1/sites/science/works/does-not-exist/versions/does-not-exist/social
        status: 404
        response:
          error: string

  # Site Submissions Routes Group
  - title: Site Submissions Routes - User has no site role
    cases:
      - title: Site submissions endpoint requires site role
        url: /v1/sites/science/submissions
        status: 401
        response:
          items: array
          links: object

      - title: Site submission by ID returns 404 for non-existent submission
        url: /v1/sites/science/submissions/does-not-exist
        status: 404
        response:
          error: string

      - title: Site submission versions returns 404 for non-existent submission
        url: /v1/sites/science/submissions/does-not-exist/versions
        status: 404
        response:
          error: string

      - title: Site submission version by ID returns 404 for non-existent version
        url: /v1/sites/science/submissions/does-not-exist/versions/cdd87129-6ea8-4ed5-8c9f-14aa94a60a01
        status: 404
        response:
          error: string

      - title: Site submission publish returns 404 for non-existent submission
        url: /v1/sites/science/submissions/does-not-exist/publish
        method: POST
        status: 404
        response:
          error: string

      - title: Site submission unpublish returns 404 for non-existent submission
        url: /v1/sites/science/submissions/does-not-exist/unpublish
        method: POST
        status: 404
        response:
          error: string

      - title: Site submission key requires site role
        url: /v1/sites/science/submissions/key/does-not-exist
        status: 403
        response:
          status: 403
          message: string

  # Works Routes Group
  - title: Works Routes
    cases:
      - title: Works endpoint returns 405 method not allowed
        url: /v1/works
        status: 405
        response:
          error: string

      - title: Work by ID returns 404 for non-existent work
        url: /v1/works/does-not-exist
        status: 404
        response:
          error: string

      - title: Work thumbnail returns 404 for non-existent work
        url: /v1/works/does-not-exist/thumbnail
        status: 404
        response:
          error: string

      - title: Work versions endpoint returns 405 method not allowed
        url: /v1/works/does-not-exist/versions
        status: 405
        response:
          error: string

      - title: Work key returns false for non-existent key
        url: /v1/works/key/does-not-exist
        status: 200
        response:
          exists: boolean
          exact:
            exists: false

  # Upload Routes Group
  - title: Upload Routes
    headers:
      Content-Type: application/json
    cases:
      - title: Upload commit endpoint returns 400 for invalid request
        url: /v1/uploads/commit
        method: POST
        status: 400
        response:
          status: string
          message: string
          exact:
            message: invalid request body

      - title: Upload stage endpoint returns 400 for invalid request
        url: /v1/uploads/stage
        method: POST
        status: 400
        response:
          status: string
          message: string
          exact:
            message: invalid request body

  # Preview Routes Group
  - title: Preview Routes
    cases:
      - title: Preview endpoint returns 404 for non-existent preview
        url: /v1/previews/does-not-exist
        status: 404
        response:
          error: string

  # Job Routes Group
  - title: Job Routes
    cases:
      - title: Jobs endpoint returns 405 method not allowed
        url: /v1/jobs
        status: 405
        response:
          error: string

      - title: Job by ID returns job details
        url: /v1/jobs/018b9034-d660-7a20-9135-5794c1eb0bfc
        status: 200
        response:
          id: string
          status: string
          job_type: string
          messages: array
          results: object

  # Check Routes Group
  - title: Check Routes
    cases:
      - title: Checks endpoint returns available checks
        url: /v1/checks
        status: 200
        response:
          items: array
          links: object

      - title: Check by ID returns check details
        url: /v1/checks/authors-exist
        status: 200
        response:
          id: string
          title: string
          purpose: string
          tags: array
          links: object

      - title: Check docs endpoint returns documentation
        url: /v1/checks/authors-exist/docs
        status: 200
        response:
          kind: string
          frontmatter: object
          mdast: object

  # DNS Router Routes Group
  - title: DNS Router Routes
    cases:
      - title: Routers GET not allowed
        url: /v1/routers
        status: 405
      - title: Domain not found
        url: /v1/routers/docker.space
        status: 404
      - title: Domain with incorrect username fails
        url: /v1/routers
        method: POST
        status: 400
        headers:
          Content-Type: application/json
        body:
          domain: nottest.curve.space
          cdn: https://cdn.test.dev
          cdn_key: 9208e5ae-3adb-4de1-b380-3f810aaae08b
      - title: Domain created
        url: /v1/routers
        method: POST
        status: 201
        headers:
          Content-Type: application/json
        body:
          domain: test.curve.space
          cdn: https://cdn.test.dev
          cdn_key: 9208e5ae-3adb-4de1-b380-3f810aaae08b
      - title: Domain found after creation
        url: /v1/routers/test.curve.space
        status: 200
        response:
          domain: string
          cdn: string
          cdn_key: string
          owner: string
